@page "/converter"
@using MboxToPstBlazorApp.Services
@inject EmailService EmailService
@rendermode InteractiveServer

<PageTitle>Email Converter</PageTitle>

<h1>Email Format Converter</h1>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Conversion Settings</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="inputPath" class="form-label">Input File Path:</label>
                    <input type="text" class="form-control" id="inputPath" @bind="inputPath" placeholder="Enter path to MBOX or PST file" />
                    <small class="form-text text-muted">Supported formats: .mbox, .pst</small>
                </div>

                <div class="mb-3">
                    <label for="outputPath" class="form-label">Output File Path:</label>
                    <input type="text" class="form-control" id="outputPath" @bind="outputPath" placeholder="Enter path for converted file" />
                    <small class="form-text text-muted">File extension determines conversion direction</small>
                </div>

                <div class="mb-3">
                    <button class="btn btn-primary me-2" @onclick="StartConversion" disabled="@isConverting">
                        @if (isConverting)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <text>Converting...</text>
                        }
                        else
                        {
                            <text>Convert</text>
                        }
                    </button>
                    <button class="btn btn-secondary" @onclick="LoadEmails" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <text>Loading...</text>
                        }
                        else
                        {
                            <text>Load Emails</text>
                        }
                    </button>
                </div>

                @if (!string.IsNullOrEmpty(statusMessage))
                {
                    <div class="alert @statusAlertClass">
                        @statusMessage
                    </div>
                }

                @if (isConverting)
                {
                    <div class="mb-3">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: @(conversionProgress)%" aria-valuenow="@conversionProgress" aria-valuemin="0" aria-valuemax="100">
                                @conversionProgress%
                            </div>
                        </div>
                        <small class="text-muted">@progressMessage</small>
                    </div>
                }

                @if (isLoading)
                {
                    <div class="mb-3">
                        <div class="progress">
                            <div class="progress-bar bg-info" role="progressbar" style="width: @(loadingProgress)%" aria-valuenow="@loadingProgress" aria-valuemin="0" aria-valuemax="100">
                                @loadingProgress%
                            </div>
                        </div>
                        <small class="text-muted">@loadingMessage</small>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Email Preview</h5>
            </div>
            <div class="card-body">
                @if (emails != null && emails.Count > 0)
                {
                    <div class="mb-3">
                        @if (isLargeFile)
                        {
                            <small class="text-muted">Found @totalEmailCount emails (showing first @emails.Count for preview)</small>
                            <br />
                            <small class="text-info">‚ÑπÔ∏è Large file optimization: Only first @emails.Count emails loaded for preview. All @totalEmailCount emails will be converted during conversion.</small>
                        }
                        else
                        {
                            <small class="text-muted">Found @emails.Count emails</small>
                        }
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        @foreach (var email in emails)
                        {
                            <div class="card mb-2" style="cursor: pointer;" @onclick="() => SelectEmail(email)">
                                <div class="card-body p-2">
                                    <h6 class="card-title mb-1">@email.Subject</h6>
                                    <p class="card-text small mb-1">
                                        <strong>From:</strong> @email.From<br />
                                        <strong>Date:</strong> @email.Date.ToString("yyyy-MM-dd HH:mm")
                                        @if (email.HasAttachments)
                                        {
                                            <span class="badge bg-secondary ms-2">üìé</span>
                                        }
                                    </p>
                                </div>
                            </div>
                        }
                        @if (isLargeFile && totalEmailCount > emails.Count)
                        {
                            <small class="text-muted">... and @(totalEmailCount - emails.Count) more emails (will be included in conversion)</small>
                        }
                    </div>
                }
                else if (!string.IsNullOrEmpty(inputPath))
                {
                    <p class="text-muted">Click "Load Emails" to preview emails from the selected file.</p>
                }
                else
                {
                    <p class="text-muted">Enter a file path to preview emails.</p>
                }
            </div>
        </div>
    </div>
</div>

@if (eventLog.Any())
{
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Event Log / Progress Log</h5>
                </div>
                <div class="card-body">
                    <div style="max-height: 200px; overflow-y: auto; background-color: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.85em;">
                        @foreach (var logEntry in eventLog.AsEnumerable().Reverse())
                        {
                            <div>@logEntry</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@if (selectedEmail != null)
{
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Selected Email Details</h5>
                </div>
                <div class="card-body">
                    <h6>@selectedEmail.Subject</h6>
                    <p><strong>From:</strong> @selectedEmail.From</p>
                    <p><strong>To:</strong> @selectedEmail.To</p>
                    <p><strong>Date:</strong> @selectedEmail.Date.ToString("yyyy-MM-dd HH:mm:ss")</p>
                    <hr />
                    <div style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa; padding: 10px; border-radius: 5px;">
                        <pre style="white-space: pre-wrap;">@selectedEmail.Body</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private string inputPath = "";
    private string outputPath = "";
    private List<EmailSummary>? emails;
    private EmailSummary? selectedEmail;
    private bool isLoading = false;
    private bool isConverting = false;
    private string statusMessage = "";
    private string statusAlertClass = "";
    private int conversionProgress = 0;
    private string progressMessage = "";
    private int loadingProgress = 0;
    private string loadingMessage = "";
    private List<string> eventLog = new List<string>();
    private int totalEmailCount = 0;
    private bool isLargeFile = false;

    private async Task LoadEmails()
    {
        if (string.IsNullOrWhiteSpace(inputPath))
        {
            SetStatusMessage("Please enter an input file path.", "alert-warning");
            return;
        }

        if (!File.Exists(inputPath))
        {
            SetStatusMessage("Input file not found.", "alert-danger");
            return;
        }

        isLoading = true;
        selectedEmail = null;
        emails = null;
        totalEmailCount = 0;
        isLargeFile = false;
        eventLog.Clear();
        loadingProgress = 0;
        loadingMessage = "Preparing to load emails...";

        AddToEventLog("Starting email loading process...");

        try
        {
            var extension = Path.GetExtension(inputPath).ToLowerInvariant();

            var progress = new Progress<EmailLoadingProgress>(p =>
            {
                loadingMessage = p.Message;
                if (p.EmailCount > 0)
                {
                    // For large files, we can't easily calculate exact percentage
                    // so we'll show progress based on message count
                    var estimatedProgress = Math.Min(90, p.EmailCount / 100); // Cap at 90% during loading
                    loadingProgress = estimatedProgress;
                }
                AddToEventLog(p.Message);
                InvokeAsync(StateHasChanged);
            });

            if (extension == ".mbox")
            {
                // Check file size to decide on loading strategy
                var fileInfo = new FileInfo(inputPath);
                var fileSizeMB = fileInfo.Length / 1024.0 / 1024.0;
                
                if (fileSizeMB > 50) // For files larger than 50MB, use optimized approach
                {
                    isLargeFile = true;
                    AddToEventLog($"Large file detected ({fileSizeMB:F2} MB). Using optimized loading...");
                    
                    var metadata = await EmailService.GetEmailMetadataFromMboxAsync(inputPath, progress);
                    emails = metadata.PreviewEmails;
                    totalEmailCount = metadata.TotalEmailCount;
                    
                    SetStatusMessage($"Successfully loaded metadata for {totalEmailCount} emails. Showing first {emails.Count} for preview.", "alert-success");
                    AddToEventLog($"Optimized loading completed. Total emails: {totalEmailCount}, Preview: {emails.Count}");
                }
                else
                {
                    // For smaller files, load all emails as before
                    emails = await EmailService.GetEmailsFromMboxAsync(inputPath, progress);
                    totalEmailCount = emails.Count;
                    SetStatusMessage($"Successfully loaded {emails.Count} emails.", "alert-success");
                    AddToEventLog($"Standard loading completed. Total emails: {emails.Count}");
                }
            }
            else if (extension == ".pst")
            {
                emails = await EmailService.GetEmailsFromPstAsync(inputPath);
                totalEmailCount = emails.Count;
                SetStatusMessage($"Successfully loaded {emails.Count} emails.", "alert-success");
                AddToEventLog($"PST loading completed. Total emails: {emails.Count}");
            }
            else
            {
                SetStatusMessage("Unsupported file format. Please use .mbox or .pst files.", "alert-warning");
                return;
            }

            loadingProgress = 100;
            loadingMessage = "Loading completed!";
        }
        catch (Exception ex)
        {
            SetStatusMessage($"Error loading emails: {ex.Message}", "alert-danger");
            AddToEventLog($"Error loading emails: {ex.Message}");
            emails = null;
            totalEmailCount = 0;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task StartConversion()
    {
        if (string.IsNullOrWhiteSpace(inputPath) || string.IsNullOrWhiteSpace(outputPath))
        {
            SetStatusMessage("Please enter both input and output file paths.", "alert-warning");
            return;
        }

        if (!File.Exists(inputPath))
        {
            SetStatusMessage("Input file not found.", "alert-danger");
            return;
        }

        var inputExt = Path.GetExtension(inputPath).ToLowerInvariant();
        var outputExt = Path.GetExtension(outputPath).ToLowerInvariant();

        if (!((inputExt == ".mbox" && outputExt == ".pst") || (inputExt == ".pst" && outputExt == ".mbox")))
        {
            SetStatusMessage("Unsupported conversion. Supported: .mbox to .pst or .pst to .mbox", "alert-warning");
            return;
        }

        isConverting = true;
        conversionProgress = 0;
        progressMessage = "Preparing conversion...";

        AddToEventLog($"Starting conversion from {inputExt} to {outputExt}");
        AddToEventLog($"Input file: {Path.GetFileName(inputPath)}");
        AddToEventLog($"Output file: {Path.GetFileName(outputPath)}");

        var progress = new Progress<ConversionProgress>(p =>
        {
            conversionProgress = p.ProgressPercentage;
            progressMessage = p.Message;
            AddToEventLog(p.Message);
            InvokeAsync(StateHasChanged);
        });

        try
        {
            ConversionResult result;

            if (inputExt == ".mbox" && outputExt == ".pst")
            {
                result = await EmailService.ConvertMboxToPstAsync(inputPath, outputPath, progress);
            }
            else
            {
                result = await EmailService.ConvertPstToMboxAsync(inputPath, outputPath, progress);
            }

            if (result.Success)
            {
                SetStatusMessage(result.Message, "alert-success");
                AddToEventLog($"Conversion completed successfully: {result.Message}");
            }
            else
            {
                SetStatusMessage($"Conversion failed: {result.Message}", "alert-danger");
                AddToEventLog($"Conversion failed: {result.Message}");
            }
        }
        catch (Exception ex)
        {
            SetStatusMessage($"Conversion error: {ex.Message}", "alert-danger");
            AddToEventLog($"Conversion error: {ex.Message}");
        }
        finally
        {
            isConverting = false;
        }
    }

    private void SelectEmail(EmailSummary email)
    {
        selectedEmail = email;
    }

    private void SetStatusMessage(string message, string alertClass)
    {
        statusMessage = message;
        statusAlertClass = alertClass;
    }

    private void AddToEventLog(string message)
    {
        var timestamp = DateTime.Now.ToString("HH:mm:ss");
        eventLog.Add($"[{timestamp}] {message}");
        
        // Keep only the last 50 log entries to prevent memory issues
        if (eventLog.Count > 50)
        {
            eventLog.RemoveAt(0);
        }
    }
}